From 7c68ab6fefbffd5a29e56b894a3255fe8d695be9 Mon Sep 17 00:00:00 2001
From: Juho Kilpikoski <juho.kilpikoski@iki.fi>
Date: Fri, 9 Apr 2010 11:46:19 +0300
Subject: [PATCH 4/4] BUGFIX: Fix bug #1 by disabeling request forgery protection for login and logout

---
 .../app/controllers/application_controller.rb      |    6 +-
 .../app/controllers/sessions_controller.rb         |    7 +-
 milloinviimeksi/log/development.log                |  203 ++++++++++++++++++++
 3 files changed, 213 insertions(+), 3 deletions(-)

diff --git a/milloinviimeksi/app/controllers/application_controller.rb b/milloinviimeksi/app/controllers/application_controller.rb
index 3592304..b94916e 100644
--- a/milloinviimeksi/app/controllers/application_controller.rb
+++ b/milloinviimeksi/app/controllers/application_controller.rb
@@ -8,12 +8,16 @@ class ApplicationController < ActionController::Base
   before_filter :authenticate_required
 
   def authenticate_required
-    unless session[:user_id]
+    unless logged_in?
       redirect_to session_path
       return false
     end
   end
 
+  def logged_in?
+    session[:user_id]
+  end
+
   # Scrub sensitive parameters from your log
   # filter_parameter_logging :password
 end
diff --git a/milloinviimeksi/app/controllers/sessions_controller.rb b/milloinviimeksi/app/controllers/sessions_controller.rb
index 483ec59..fed144a 100644
--- a/milloinviimeksi/app/controllers/sessions_controller.rb
+++ b/milloinviimeksi/app/controllers/sessions_controller.rb
@@ -1,4 +1,6 @@
 class SessionsController < ApplicationController
+
+  protect_from_forgery :except => [:create, :destroy]
   skip_before_filter :authenticate_required, :only => [:show, :create]
 
   def create
@@ -6,13 +8,13 @@ class SessionsController < ApplicationController
       user = User.authenticate(params[:user][:name], params[:user][:password])
     rescue
       flash[:warning] = 'You shall not pass!'
-      redirect_to root_path
+      redirect_to :root
       return
     end
 
     flash[:notice] = 'Multipass!'
     log_user_in user
-    redirect_to root_path
+    redirect_to :root
 
   end
 
@@ -27,6 +29,7 @@ class SessionsController < ApplicationController
   end
 
   def show
+    redirect_to :root if logged_in?
   end
 
 end
diff --git a/milloinviimeksi/log/development.log b/milloinviimeksi/log/development.log
index c3e7990..68f9776 100644
--- a/milloinviimeksi/log/development.log
+++ b/milloinviimeksi/log/development.log
@@ -2397,3 +2397,206 @@ Completed in 29ms (View: 23, DB: 0) | 200 OK [http://localhost/events/1]
   [4;35;1mSQL (1.7ms)[0m   [0mINSERT INTO "schema_migrations" (version) VALUES ('20100325122256')[0m
   [4;36;1mSQL (2.5ms)[0m   [0;1mINSERT INTO "schema_migrations" (version) VALUES ('20100328152048')[0m
   [4;35;1mSQL (1.7ms)[0m   [0mINSERT INTO "schema_migrations" (version) VALUES ('20100329123847')[0m
+
+
+Processing SessionsController#destroy (for 127.0.0.1 at 2010-04-09 11:37:12) [DELETE]
+  Parameters: {"authenticity_token"=>"dDwGeSHoauQrNgjCEgQaUdIvUzZoi3xXzxotAgYruxk="}
+Redirected to http://localhost:3000/
+Completed in 2ms (DB: 0) | 302 Found [http://localhost/session]
+
+
+Processing EventsController#index (for 127.0.0.1 at 2010-04-09 11:37:12) [GET]
+Redirected to http://localhost:3000/session
+Filter chain halted as [:authenticate_required] rendered_or_redirected.
+Completed in 1ms (DB: 0) | 302 Found [http://localhost/]
+
+
+Processing SessionsController#show (for 127.0.0.1 at 2010-04-09 11:37:12) [GET]
+Rendering template within layouts/application
+Rendering sessions/show
+Completed in 4ms (View: 3, DB: 0) | 200 OK [http://localhost/session]
+
+
+Processing SessionsController#create (for 127.0.0.1 at 2010-04-09 11:37:15) [POST]
+  Parameters: {"commit"=>"Login", "authenticity_token"=>"sgTcQTVgmtWP04vW4JzFWFeFlDyOUXbLNc25KdMOiMA=", "user"=>{"name"=>"kisu", "password"=>"kisu"}}
+  [4;36;1mUser Load (0.2ms)[0m   [0;1mSELECT * FROM "users" WHERE ("users"."name" = 'kisu') LIMIT 1[0m
+Redirected to http://localhost:3000/
+Completed in 9ms (DB: 0) | 302 Found [http://localhost/session]
+
+
+Processing EventsController#index (for 127.0.0.1 at 2010-04-09 11:37:15) [GET]
+  [4;35;1mEvent Load (0.5ms)[0m   [0mSELECT * FROM "events" [0m
+Rendering template within layouts/application
+Rendering events/index
+Completed in 10ms (View: 5, DB: 0) | 200 OK [http://localhost/]
+
+
+Processing SessionsController#destroy (for 127.0.0.1 at 2010-04-09 11:37:17) [DELETE]
+  Parameters: {"authenticity_token"=>"sgTcQTVgmtWP04vW4JzFWFeFlDyOUXbLNc25KdMOiMA="}
+Redirected to http://localhost:3000/
+Completed in 2ms (DB: 0) | 302 Found [http://localhost/session]
+
+
+Processing EventsController#index (for 127.0.0.1 at 2010-04-09 11:37:17) [GET]
+Redirected to http://localhost:3000/session
+Filter chain halted as [:authenticate_required] rendered_or_redirected.
+Completed in 1ms (DB: 0) | 302 Found [http://localhost/]
+
+
+Processing SessionsController#show (for 127.0.0.1 at 2010-04-09 11:37:17) [GET]
+Rendering template within layouts/application
+Rendering sessions/show
+Completed in 5ms (View: 3, DB: 0) | 200 OK [http://localhost/session]
+
+
+Processing SessionsController#show (for 127.0.0.1 at 2010-04-09 11:37:55) [GET]
+Rendering template within layouts/application
+Rendering sessions/show
+Completed in 4ms (View: 2, DB: 0) | 200 OK [http://localhost/session]
+
+
+Processing SessionsController#create (for 127.0.0.1 at 2010-04-09 11:37:59) [POST]
+  Parameters: {"commit"=>"Login", "authenticity_token"=>"8xk0VQHZXYHWkzo6wIgdtwgmwoIdi5xXSuQI0u48D6k=", "user"=>{"name"=>"kisu", "password"=>"kisu"}}
+  [4;36;1mUser Load (0.2ms)[0m   [0;1mSELECT * FROM "users" WHERE ("users"."name" = 'kisu') LIMIT 1[0m
+Redirected to http://localhost:3000/
+Completed in 8ms (DB: 0) | 302 Found [http://localhost/session]
+
+
+Processing EventsController#index (for 127.0.0.1 at 2010-04-09 11:37:59) [GET]
+  [4;35;1mEvent Load (0.5ms)[0m   [0mSELECT * FROM "events" [0m
+Rendering template within layouts/application
+Rendering events/index
+Completed in 68ms (View: 5, DB: 1) | 200 OK [http://localhost/]
+
+
+Processing SessionsController#show (for 127.0.0.1 at 2010-04-09 11:38:02) [GET]
+Redirected to http://localhost:3000/
+Completed in 2ms (DB: 0) | 302 Found [http://localhost/session]
+
+
+Processing EventsController#index (for 127.0.0.1 at 2010-04-09 11:38:02) [GET]
+  [4;36;1mEvent Load (0.5ms)[0m   [0;1mSELECT * FROM "events" [0m
+Rendering template within layouts/application
+Rendering events/index
+Completed in 10ms (View: 5, DB: 0) | 200 OK [http://localhost/]
+
+
+Processing SessionsController#destroy (for 127.0.0.1 at 2010-04-09 11:39:09) [DELETE]
+  Parameters: {"authenticity_token"=>"8xk0VQHZXYHWkzo6wIgdtwgmwoIdi5xXSuQI0u48D6k="}
+Redirected to http://localhost:3000/
+Completed in 2ms (DB: 0) | 302 Found [http://localhost/session]
+
+
+Processing EventsController#index (for 127.0.0.1 at 2010-04-09 11:39:09) [GET]
+Redirected to http://localhost:3000/session
+Filter chain halted as [:authenticate_required] rendered_or_redirected.
+Completed in 1ms (DB: 0) | 302 Found [http://localhost/]
+
+
+Processing SessionsController#show (for 127.0.0.1 at 2010-04-09 11:39:09) [GET]
+Rendering template within layouts/application
+Rendering sessions/show
+Completed in 23ms (View: 21, DB: 0) | 200 OK [http://localhost/session]
+
+
+Processing SessionsController#create (for 127.0.0.1 at 2010-04-09 11:39:56) [POST]
+  Parameters: {"commit"=>"Login", "authenticity_token"=>"tfXiM89O38ztcxU99WOE7Rk9hl/JXFIOZkdRlNWj3Wg=", "user"=>{"name"=>"kisu", "password"=>"kisu"}}
+  [4;36;1mUser Load (0.4ms)[0m   [0;1mSELECT * FROM "users" WHERE ("users"."name" = 'kisu') LIMIT 1[0m
+Redirected to http://localhost:3000/
+Completed in 58ms (DB: 0) | 302 Found [http://localhost/session]
+
+
+Processing EventsController#index (for 127.0.0.1 at 2010-04-09 11:39:56) [GET]
+  [4;35;1mEvent Load (0.5ms)[0m   [0mSELECT * FROM "events" [0m
+Rendering template within layouts/application
+Rendering events/index
+Completed in 28ms (View: 23, DB: 0) | 200 OK [http://localhost/]
+
+
+Processing SessionsController#destroy (for 127.0.0.1 at 2010-04-09 11:40:12) [DELETE]
+  Parameters: {"authenticity_token"=>"tfXiM89O38ztcxU99WOE7Rk9hl/JXFIOZkdRlNWj3Wg="}
+Redirected to http://localhost:3000/
+Completed in 2ms (DB: 0) | 302 Found [http://localhost/session]
+
+
+Processing EventsController#index (for 127.0.0.1 at 2010-04-09 11:40:12) [GET]
+Redirected to http://localhost:3000/session
+Filter chain halted as [:authenticate_required] rendered_or_redirected.
+Completed in 1ms (DB: 0) | 302 Found [http://localhost/]
+
+
+Processing SessionsController#show (for 127.0.0.1 at 2010-04-09 11:40:12) [GET]
+Rendering template within layouts/application
+Rendering sessions/show
+Completed in 13ms (View: 11, DB: 0) | 200 OK [http://localhost/session]
+
+
+Processing SessionsController#create (for 127.0.0.1 at 2010-04-09 11:41:40) [POST]
+  Parameters: {"commit"=>"Login", "user"=>{"name"=>"kisu", "password"=>"kisu"}}
+
+ActionController::InvalidAuthenticityToken (ActionController::InvalidAuthenticityToken):
+  
+
+Rendered rescues/_trace (102.1ms)
+Rendered rescues/_request_and_response (1.3ms)
+Rendering rescues/layout (unprocessable_entity)
+
+
+Processing SessionsController#create (for 127.0.0.1 at 2010-04-09 11:43:04) [POST]
+  Parameters: {"commit"=>"Login", "user"=>{"name"=>"kisu", "password"=>"kisu"}}
+  [4;36;1mUser Load (0.2ms)[0m   [0;1mSELECT * FROM "users" WHERE ("users"."name" = 'kisu') LIMIT 1[0m
+Redirected to http://localhost:3000/
+Completed in 8ms (DB: 0) | 302 Found [http://localhost/session]
+
+
+Processing EventsController#index (for 127.0.0.1 at 2010-04-09 11:43:05) [GET]
+  [4;35;1mEvent Load (0.5ms)[0m   [0mSELECT * FROM "events" [0m
+Rendering template within layouts/application
+Rendering events/index
+Completed in 9ms (View: 5, DB: 0) | 200 OK [http://localhost/]
+
+
+Processing SessionsController#create (for 127.0.0.1 at 2010-04-09 11:43:29) [POST]
+  Parameters: {"commit"=>"Login", "user"=>{"name"=>"kisu", "password"=>"kisu"}}
+  [4;36;1mUser Load (0.2ms)[0m   [0;1mSELECT * FROM "users" WHERE ("users"."name" = 'kisu') LIMIT 1[0m
+Redirected to http://localhost:3000/
+Completed in 8ms (DB: 0) | 302 Found [http://localhost/session]
+
+
+Processing EventsController#index (for 127.0.0.1 at 2010-04-09 11:43:29) [GET]
+  [4;35;1mEvent Load (0.5ms)[0m   [0mSELECT * FROM "events" [0m
+Rendering template within layouts/application
+Rendering events/index
+Completed in 10ms (View: 5, DB: 1) | 200 OK [http://localhost/]
+
+
+Processing SessionsController#create (for 127.0.0.1 at 2010-04-09 11:43:37) [POST]
+  Parameters: {"commit"=>"Login", "user"=>{"name"=>"kisu", "password"=>"kisu"}}
+  [4;36;1mUser Load (0.2ms)[0m   [0;1mSELECT * FROM "users" WHERE ("users"."name" = 'kisu') LIMIT 1[0m
+Redirected to http://localhost:3000/
+Completed in 8ms (DB: 0) | 302 Found [http://localhost/session]
+
+
+Processing EventsController#index (for 127.0.0.1 at 2010-04-09 11:43:37) [GET]
+  [4;35;1mEvent Load (0.5ms)[0m   [0mSELECT * FROM "events" [0m
+Rendering template within layouts/application
+Rendering events/index
+Completed in 72ms (View: 67, DB: 0) | 200 OK [http://localhost/]
+
+
+Processing SessionsController#destroy (for 127.0.0.1 at 2010-04-09 11:43:49) [DELETE]
+  Parameters: {"authenticity_token"=>"ePYqivhnn8esmOBG2sB1K+x9q81q7hb7wTGzCmoIIFk="}
+Redirected to http://localhost:3000/
+Completed in 2ms (DB: 0) | 302 Found [http://localhost/session]
+
+
+Processing EventsController#index (for 127.0.0.1 at 2010-04-09 11:43:49) [GET]
+Redirected to http://localhost:3000/session
+Filter chain halted as [:authenticate_required] rendered_or_redirected.
+Completed in 1ms (DB: 0) | 302 Found [http://localhost/]
+
+
+Processing SessionsController#show (for 127.0.0.1 at 2010-04-09 11:43:49) [GET]
+Rendering template within layouts/application
+Rendering sessions/show
+Completed in 5ms (View: 3, DB: 0) | 200 OK [http://localhost/session]
-- 
1.7.0.3

